<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="EVM,">





  <link rel="alternate" href="/atom.xml" title="体验官" type="application/atom+xml">






<meta name="description" content="深入理解 EVM（二）">
<meta name="keywords" content="EVM">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解 EVM（二）">
<meta property="og:url" content="tiyanguan.github.io/2022/08/28/Ethereum-2022-08-28-深入理解-EVM（二）/index.html">
<meta property="og:site_name" content="体验官">
<meta property="og:description" content="深入理解 EVM（二）">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="/upload_image/2022-08-28-深入理解%20EVM2/1.png">
<meta property="og:updated_time" content="2022-08-29T12:59:34.907Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解 EVM（二）">
<meta name="twitter:description" content="深入理解 EVM（二）">
<meta name="twitter:image" content="/upload_image/2022-08-28-深入理解%20EVM2/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="tiyanguan.github.io/2022/08/28/Ethereum-2022-08-28-深入理解-EVM（二）/">





<link rel="stylesheet" href="/js/prism/prism.css">

  <title>深入理解 EVM（二） | 体验官</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <!-- 在右上角或者左上角实现fork me on github -->
    <a href="https://github.com/tiyanguan"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">体验官</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">for myself, not only myself</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-分类">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-标签">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="tiyanguan.github.io/2022/08/28/Ethereum-2022-08-28-深入理解-EVM（二）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="martin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="体验官">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">深入理解 EVM（二）</h1>
        

        <div class="post-meta">
          <span class="post-time">
                      
                        <span class="post-meta-item-icon">
                          <i class="fa fa-calendar-o"></i>
                        </span>
                        
                          <span class="post-meta-item-text">发表于</span>
                        
                        <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-08-28T00:00:00+08:00">
                          2022-08-28
                        </time>
                      

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ethereum/" itemprop="url" rel="index">
                    <span itemprop="name">Ethereum</span>
                  </a>
                </span>

                
                
              
            </span>
          


          
          
             <span id="/2022/08/28/Ethereum-2022-08-28-深入理解-EVM（二）/" class="leancloud_visitors" data-flag-title="深入理解 EVM（二）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度</span>
               
                 <span id="busuanzi_container_page_pv">
                   <span id="busuanzi_value_page_pv"></span>
                 </span>
                 <span class="leancloud-visitors-count"></span>
                 <span>℃</span>
             </span>
          

          
           <span class="post-meta-divider">|</span>
          

                      
                        
                        <span class="post-meta-item-icon">
                          <i class="fa fa-file-word-o"></i>
                        </span>
                        
                          <span class="post-meta-item-text">字数统计</span>
                        
                        <span title="字数统计">
                          2,423
                        </span>
                      

                      
                        <span class="post-meta-divider">|</span>
                      

                      
                        <span class="post-meta-item-icon">
                          <i class="fa fa-clock-o"></i>
                        </span>
                        
                          <span class="post-meta-item-text">阅读时长 &asymp;</span>
                        
                        <span title="阅读时长">
                          10
                        </span>
                      

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote class="blockquote-center"> 深入理解 EVM（二） </blockquote>

<a id="more"></a>
<p>上篇<a href="2022-08-28-深入理解%20EVM（二）.md">文章</a>我们简要介绍了一下合约的<strong>字节码构造</strong>以及<strong>内存布局</strong>，今天我们来从字节码层面聊聊合约的部署过程。</p>
<h2 id="编译合约"><a href="#编译合约" class="headerlink" title="编译合约"></a>编译合约</h2><p>我们来看一个例子：</p>
<pre><code class="line-numbers language-solidity">// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.15;

contract Demo {
    constructor() {}
}
</code></pre>
<p>这个合约比上篇文章的还要简单，它什么内容都没有，仅仅有一个合约的框架而已，这样我们就可以不用关心一些额外内容比如变量赋值等，只需关心合约部署的最核心步骤。</p>
<p>先使用 <code>solc</code> 进行编译：</p>
<blockquote>
<p>solc Demo.sol --bin</p>
</blockquote>
<p>编译后的字节码为：</p>
<pre><code>6080604052348015600f57600080fd5b50603f80601d6000396000f3fe6080604052600080fdfea2646970667358221220c6a9021ede10c2befd51f04c8bcd9294ea47f79868b9ad6d81af3e41d3b2c2bf64736f6c634300080f0033
</code></pre><p>按照 <code>0xfe</code> 操作符分割后的结果为：</p>
<pre><code>6080604052348015600f57600080fd5b50603f80601d6000396000f3（init bytecode）

6080604052600080fd（runtime bytecode）

a2646970667358221220c6a9021ede10c2befd51f04c8bcd9294ea47f79868b9ad6d81af3e41d3b2c2bf64736f6c634300080f0033（metadata hash）
</code></pre><p>其中 <code>init bytecode</code> 部分就是<strong>合约的部署流程</strong>，我们主要着重于这部分。</p>
<p>我们前面说过，这些字节码对应的其实都是 opcodes，也就是操作符和操作数，我们可以通过</p>
<blockquote>
<p>solc Demo.sol --opcodes</p>
</blockquote>
<p>来得到对应的 opcodes：</p>
<pre><code>PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH1 0xF JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x3F DUP1 PUSH1 0x1D PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN INVALID PUSH1 0x80 PUSH1 0x40 MSTORE PUSH1 0x0 DUP1 REVERT INVALID LOG2 PUSH5 0x6970667358 0x22 SLT KECCAK256 0xC6 0xA9 MUL 0x1E 0xDE LT 0xC2 0xBE REVERT MLOAD CREATE 0x4C DUP12 0xCD SWAP3 SWAP5 0xEA SELFBALANCE 0xF7 SWAP9 PUSH9 0xB9AD6D81AF3E41D3B2 0xC2 0xBF PUSH5 0x736F6C6343 STOP ADDMOD 0xF STOP CALLER
</code></pre><p>我们将 <code>init bytecode</code> 部分的 16 进制字节码与其 opcodes 一一对应起来：</p>
<pre><code>0  -&gt; 60 PUSH1
1  -&gt; 80 0x80
2  -&gt; 60 PUSH1
3  -&gt; 40 0x40
4  -&gt; 52 MSTORE
5  -&gt; 34 CALLVALUE
6  -&gt; 80 DUP1
7  -&gt; 15 ISZERO
8  -&gt; 60 PUSH1
9  -&gt; 0f 0xF
10 -&gt; 57 JUMPI
11 -&gt; 60 PUSH1
12 -&gt; 00 0x0
13 -&gt; 80 DUP1
14 -&gt; fd REVERT
15 -&gt; 5b JUMPDEST
16 -&gt; 50 POP
17 -&gt; 60 PUSH1
18 -&gt; 3f 0x3F
19 -&gt; 80 DUP1
20 -&gt; 60 PUSH1
21 -&gt; 1d 0x1D
22 -&gt; 60 PUSH1
23 -&gt; 00 0x0
24 -&gt; 39 CODECOPY
25 -&gt; 60 PUSH1
26 -&gt; 00 0x0
27 -&gt; f3 RETURN
</code></pre><p>我们今天的目标就是把这些字节码搞懂，看看它都干了些什么。</p>
<h2 id="合约部署流程"><a href="#合约部署流程" class="headerlink" title="合约部署流程"></a>合约部署流程</h2><p>开头的 0 → 4 是我们前面讲过的加载空闲内存指针的过程，即 <code>MSTORE(0x40, 0x80)</code>，此时内存中的数据为（第三行的最后为 80）：</p>
<pre><code>0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000080
0000000000000000000000000000000000000000000000000000000000000000
</code></pre><p>每一行的长度是 64，即 32 个字节。我们前面说过 <code>0x40</code> - <code>0x5f</code> 内存区域是用来存储空闲内存指针的，对照上面结果，确实如此。</p>
<p>接下来，第 5 行的 <code>CALLVALUE</code>，获取创建合约时发送的 ETH 数量，并存入栈中。我们创建该合约并不需要同时发送 ETH，因此值为 0。此时的栈中数据为（左边是栈底，右边是栈顶，下同）：</p>
<pre><code>| 0
</code></pre><p>第 6 行的 <code>DUP1</code>，会取栈顶第一个元素，也就是 0，并且复制一份，再放入栈中。此时，栈中数据为：</p>
<pre><code>| 0 | 0
</code></pre><p>第 7 行 <code>ISZERO</code>，取出栈顶元素，判断是否为 0，若为 0，返回 1，否则返回 0，最后将结果放入栈中。此时，栈为：</p>
<pre><code>| 0 | 1
</code></pre><p>第 8、9 行，将 0xF 放入栈中。此时，栈为：</p>
<pre><code>| 0 | 1 | F
</code></pre><p>第 10 行，<code>JUMPI</code> 会取出栈顶的两个元素，并将其作为参数，即 <code>JUMPI(F, 1)</code>，如果第二个参数是 1，则跳转到第一个参数，也就是 <code>F</code> 位置，如果不是 1，则不跳转。这里需要跳转，<code>F</code> 是 16 进制中的 15，因此需要跳转到 15 行。这个 15 行，也就是从 0 开始第 15 个字节处。每个操作符都消耗一个字节，操作数也同样消耗字节。此时，栈为：</p>
<pre><code>| 0
</code></pre><p>第 15 行是 <code>JUMPDEST</code>，是跳转的目标位，也就是说，凡是 <code>JUMPI</code> 指令进行跳转，跳转的目标必须是它，它本身并没有什么实际作用，仅仅用做标记位。如果跳转至此，没有该操作符，则流程失败。</p>
<p>第 16 行，<code>POP</code> 会弹出栈顶的元素，即弹出 0。此时栈为空：</p>
<pre><code>|
</code></pre><p>第 17、18 行，<code>PUSH1 3F</code>，即将 <code>0x3F</code> 放入栈中。此时，栈为：</p>
<pre><code>| 3F
</code></pre><p>第 19 行，<code>DUP1</code> 复制栈顶元素。此时，栈为：</p>
<pre><code>| 3F | 3F
</code></pre><p>第 20 到 23 行，连续将两个元素 <code>0x1D</code>、<code>0x0</code> 放入栈中。此时，栈为：</p>
<pre><code>| 3F | 3F | 1D | 0
</code></pre><p>第 24 行，<code>CODECOPY</code>，将当前运行环境中的字节码复制到内存中，接收 3 个参数，分别是<strong>目标内存位置</strong>、<strong>要复制数据的起始位置</strong>、<strong>复制长度</strong>。这里是 <code>CODECOPY(0, 1D, 3F)</code>，即从字节码中的 <code>1D</code> 起始，复制长度为 <code>3F</code> 的字节码到内存位置 <code>0</code> 处。</p>
<p>我们来看看这几个参数是什么意思，首先第一个参数是说将结果都放在 0 开始的内存处，这个好理解。第二个参数 <code>1D</code>，换成 10 进制是 <code>29</code>，我们前面看的 <code>init bytecode</code> 部分一共有 27 行（算上 0 行有 28 行），由于我们是按照 <code>0xfe</code> 来将其分割的，因此按照全部字节码来说，<code>0xfe</code> 是位于第 28 行的，而第 29 行开始的部分就是 <code>runtime bytecode</code> 了。也就是说，我们需要从 <code>runtime bytecode</code> 处开始复制代码，长度是 <code>0x3F</code>，即 10 进制的 <code>63</code>。我们再来看整体的字节码，从 <code>runtime bytecode</code> 处的 <code>6080604052…</code> 开始的字节码，一直到最后，长度是 <code>126</code>，恰好是 <code>63</code> 个字节。</p>
<p>也就是说，我们将除了 <code>init bytecode</code> 部分的 <code>runtime bytecode</code> 与 <code>metadata hash</code> 复制到了内存中。此时，内存中数据为：</p>
<pre><code>6080604052600080fdfea2646970667358221220c6a9021ede10c2befd51f04c
8bcd9294ea47f79868b9ad6d81af3e41d3b2c2bf64736f6c634300080f003300
0000000000000000000000000000000000000000000000000000000000000080
0000000000000000000000000000000000000000000000000000000000000000
</code></pre><p>同时，栈中数据为：</p>
<pre><code>| 3F
</code></pre><p>接下来，第 25、26 行，<code>PUSH1 0x0</code> 将 <code>0</code> 放入了栈中。此时，栈为：</p>
<pre><code>| 3F | 0
</code></pre><p>最后，第 27 行，<code>RETURN</code> 从内存中读取数据并返回给 EVM，并结束流程。它接收两个参数，分别是起始位置以及长度，即 <code>RETURN(0, 3F)</code>。前面我们说了 <code>0x3F</code> 是 <code>runtime bytecode</code> 与 <code>metadata hash</code> 的长度，也就说从内存中读取了这两部分的数据，并返回。即返回值为：</p>
<pre><code>6080604052600080fdfea2646970667358221220c6a9021ede10c2befd51f04c
8bcd9294ea47f79868b9ad6d81af3e41d3b2c2bf64736f6c634300080f0033
</code></pre><p>此时，栈中数据已经清空。</p>
<p>现在，我们已经走完了部署的整个流程，可以看到，整个部署的流程主要就是简单的两步：</p>
<ol>
<li>运行构造函数的逻辑</li>
<li>获取 <code>runtime bytecode</code> 与 <code>metadata hash</code> 的内容并返回给 EVM</li>
</ol>
<p>接下来我们回到第 5 行，这里我们获取了 <code>CALLVALUE</code>，前面的流程中值为 0。现在我们假设在创建合约的同时也发送了 ETH，那么这里得到的就是非零值，这里我们假设是在创建合约时同时发送了 1 wei（只要是非零值结果都一样），那么栈中为：</p>
<pre><code>| 1
</code></pre><p>第 6 行 <code>DUP1</code>，复制后栈为：</p>
<pre><code>| 1 | 1
</code></pre><p>第 7 行 <code>ISZERO</code>，由于栈顶非零，因此结果为 0，此时栈中为：</p>
<pre><code>| 1 | 0
</code></pre><p>第 8、9 行，将 <code>0xF</code> 放入栈中。此时，栈为：</p>
<pre><code>| 1 | 0 | F
</code></pre><p>第 10 行，<code>JUMPI(F, 0)</code>，由于第二个参数是 0，因此不跳转，继续向下执行。</p>
<p>第 11、12 行，<code>PUSH1 0x0</code> 将 <code>0</code> 放入栈中：</p>
<pre><code>| 1 | 0
</code></pre><p>第 13 行 <code>DUP1</code>，此时栈为：</p>
<pre><code>| 1 | 0 | 0
</code></pre><p>第 14 行 <code>REVERT</code>，抛出错误，流程以失败结束。</p>
<p>那么我们说的这个 <code>CALLVALUE</code> 0 或者非 0，到底是什么意思呢？</p>
<pre><code class="line-numbers language-solidity">// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.15;

contract Demo {
    constructor() {}
}
</code></pre>
<p>看看代码，其实就是因为合约中的构造函数没有 <code>payable</code> 关键字，禁止向合约中发送 ETH。因此在字节码中需要对此进行判断。那么我们就会想到，如果加上了 <code>payable</code> 之后，字节码会怎样呢？</p>
<pre><code class="line-numbers language-solidity">// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.15;

contract Demo {
    constructor() payable {}
}
</code></pre>
<p>编译后的字节码：</p>
<pre><code>6080604052603f8060116000396000f3（init bytecode）

6080604052600080fd（runtime bytecode）

a26469706673582212208c516264e3e6785d014f2db856266d96d155fdd72ef5e53ecc896b5837f13cc664736f6c634300080f0033（metadata hash）
</code></pre><p>这时我们看到 <code>init bytecode</code> 部分短了很多，其实就是去掉了判断 <code>CALLVALUE</code> 的部分。我们再将其与 opcodes 一一对应：</p>
<pre><code>0  -&gt; 60 PUSH1
1  -&gt; 80 0x80
2  -&gt; 60 PUSH1
3  -&gt; 40 0x40
4  -&gt; 52 MSTORE
5  -&gt; 60 PUSH1
6  -&gt; 3f 0x3F
7  -&gt; 80 DUP1
8  -&gt; 60 PUSH1
9  -&gt; 11 0x11
10 -&gt; 60 PUSH1
11 -&gt; 00 0x0
12 -&gt; 39 CODECOPY
13 -&gt; 60 PUSH1
14 -&gt; 00 0x0
15 -&gt; f3 RETURN
</code></pre><p>我们再简单过一下流程。</p>
<p>0 → 4: <code>MSTORE(0x40, 0x80)</code>，内存为：</p>
<pre><code>0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000080
0000000000000000000000000000000000000000000000000000000000000000
</code></pre><p>5 → 6: <code>PUSH1 0x3F</code></p>
<pre><code>| 3F
</code></pre><p>7: <code>DUP1</code></p>
<pre><code>| 3F | 3F
</code></pre><p>8 → 9: <code>PUSH1 0x11</code></p>
<pre><code>| 3F | 3F | 11
</code></pre><p>10 → 11: <code>PUSH1 0x0</code></p>
<pre><code>| 3F | 3F | 11 | 0
</code></pre><p>12: <code>CODECOPY(0, 11, 3F)</code>，此时内存为：</p>
<pre><code>6080604052600080fdfea26469706673582212208c516264e3e6785d014f2db8
56266d96d155fdd72ef5e53ecc896b5837f13cc664736f6c634300080f003300
0000000000000000000000000000000000000000000000000000000000000080
0000000000000000000000000000000000000000000000000000000000000000
</code></pre><p>13 → 14: <code>PUSH1 0x0</code></p>
<pre><code>| 3F | 0
</code></pre><p>15: <code>RETURN(0, 3F)</code>，内存中前 <code>3F</code> 个字节，即</p>
<pre><code>6080604052600080fdfea26469706673582212208c516264e3e6785d014f2db8
56266d96d155fdd72ef5e53ecc896b5837f13cc664736f6c634300080f0033
</code></pre><p>我们看到，由于构造函数中有 <code>payable</code> 关键字，也就是发不发送 ETH 都可以，对应于字节码的整个流程中确实没有了对于 <code>CALLVALUE</code> 的判断。</p>
<h2 id="实际部署合约"><a href="#实际部署合约" class="headerlink" title="实际部署合约"></a>实际部署合约</h2><p>我们从字节码方面走完了整个部署流程，那么我们来实际部署一个合约，来看看具体交易的细节。仍然使用最开始的合约：</p>
<pre><code class="line-numbers language-solidity">// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.15;

contract Demo {
    constructor() {}
}
</code></pre>
<p>通过 <code>Remix</code> 或者其它工具进行部署。我在 <code>Rinkeby</code> 上部署了合约，部署的交易哈希是：</p>
<pre><code>0x039c306e0ac3ad5f8a972185d2094a977b1bef97694e2872f975f70e6db4a241
</code></pre><p>利用 <code>Ethersjs</code> 读取交易详情：</p>
<p><img src="/upload_image/2022-08-28-深入理解 EVM2/1.png" alt="部署交易详情" title="部署交易详情"></p>
<p>从图中注意到两点，一个是 <code>to</code> 字段为空，一个是 <code>data</code> 字段恰好就是我们前面编译合约之后得到的字节码，这也正是<strong>部署合约交易的两个特点</strong>。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这篇文章我们学习了字节码层面的合约部署流程，我们以最简单的合约为例，逐一走过了整个流程。对于有更复杂操作的合约，原理都一样，只不过是多了一些变量赋值等操作。这里强烈推荐 <a href="https://www.evm.codes/playground" target="_blank" rel="noopener">evm.codes</a> 这个网站，将字节码放进去，我们就可以一步一步观察到实际的内存与栈中的数据，分析字节码会更加直观。</p>
<p>下篇文章我们来聊聊合约方法调用的过程，仍然是从字节码层面分析，相对会更加复杂一点，不过也更加有趣。</p>
<h2 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a><a href="https://mirror.xyz/xyyme.eth/6vqE2DRsMzlPNmh3kYiwTdMBj-9hanmxyDuTHM7tZDU" target="_blank" rel="noopener">原文链接</a></h2>
      
    </div>
    
    
    




    <div>
        
          <div>
    
        <div style="text-align:center;color: #ccc;font-size:36px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

        
    </div>

    <div>
        
          

        
    </div>

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/EVM/" rel="tag"><i class="fa fa-tag"></i> EVM</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/08/27/Ethereum-2022-08-27-深入理解-EVM（一）/" rel="next" title="深入理解 EVM（一）">
                <i class="fa fa-chevron-left"></i> 深入理解 EVM（一）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/08/29/Ethereum-2022-08-29-深入理解-EVM（三）/" rel="prev" title="深入理解 EVM（三）">
                深入理解 EVM（三） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="martin">
            
              <p class="site-author-name" itemprop="name">martin</p>
              <p class="site-description motion-element" itemprop="description">for myself, not only myself</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/tiyanguan" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yanchongsheng@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/martinyan8080" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.google.com/" title="google" target="_blank">google</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://etherscan.io/" title="etherscan" target="_blank">etherscan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.feixiaohaocn.com/" title="feixiaohao" target="_blank">feixiaohao</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#编译合约"><span class="nav-number">1.</span> <span class="nav-text">编译合约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约部署流程"><span class="nav-number">2.</span> <span class="nav-text">合约部署流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实际部署合约"><span class="nav-number">3.</span> <span class="nav-text">实际部署合约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">4.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原文链接"><span class="nav-number">5.</span> <span class="nav-text">原文链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart" aria-hidden="true"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">martin</span>
</div>



<div class="powered-by">
  <i class="fa fa-user-md"></i>
  <span id="busuanzi_container_site_uv">访问用户：<span id="busuanzi_value_site_uv"></span>次</span>
</div>


  <span class="post-meta-divider">|</span>


<div class="powered-by">
  <i class="fa fa-eye" aria-hidden="true"></i>
  <span id="busuanzi_container_site_uv">访问总量：<span id="busuanzi_value_site_pv"></span>次</span>
</div>


  <span class="post-meta-divider">|</span>


<div class="theme-info">
  <i class="fa fa-paint-brush" aria-hidden="true"></i>
  <span class="post-count">博客全站共 17.6k 字</span>
</div>



<script src="/js/prism/prism.js" async></script>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("Qu6rmVm1gcMYRPyyiWcRJaEH-gzGzoHsz", "w40lNEaD5KbJiMUWYExaMFst");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

<!-- 背景动画 -->
<!-- <script type="text/javascript" src="/js/src/particle.js"></script> -->

